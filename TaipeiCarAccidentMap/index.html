<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>è‡ºåŒ—è»Šç¦ç†±åŠ›åœ– + è¡Œæ”¿å€ç•Œç·šï¼ˆå–®æœˆç¯©é¸ï¼‹æ•´å¹´æŠ˜ç·šï¼‹åˆ†é¡åœ“é¤…ï¼‰</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.2/dist/proj4.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body { margin:0; height:100%; font-family: system-ui, "Noto Sans TC", sans-serif; }
    #map { position: absolute; inset: 0; }
    #sidePanel {
      position: absolute; top: 0; right: 0; height: 100%; width: 340px;
      background: #fff; box-shadow: -8px 0 24px rgba(0,0,0,.12);
      transform: translateX(100%); transition: transform .25s ease;
      z-index: 2; display: flex; flex-direction: column;
    }
    #sidePanel.open { transform: translateX(0); }
    .sp-header { padding: 12px 14px; border-bottom: 1px solid #e5e7eb; }
    .sp-header-top { display:flex; justify-content:space-between; align-items:center; }
    .sp-title { font-weight: 700; font-size: 14px; color:#111827; }
    .sp-close { border:0; background:#f3f4f6; width:28px; height:28px; border-radius:8px; cursor:pointer; font-weight:700; color:#374151; }
    #monthSelect { margin-top:6px; width:100%; padding:5px 8px; border:1px solid #ccc; border-radius:6px; font-size:13px; }
    .sp-body { padding: 10px 14px 80px; overflow:auto; }
    .sp-stat { display:flex; gap:8px; margin: 8px 0 12px; }
    .sp-card { flex:1; background:#f9fafb; border:1px solid #f1f5f9; border-radius:10px; padding:10px; text-align:center; }
    .sp-card .kpi { font-size:18px; font-weight:800; color:#111827; }
    .sp-card .lbl { font-size:12px; color:#6b7280; }
    .chartBox { width: 100%; display:flex; justify-content:center; }
    .chartTitle { margin:6px 0 2px; font-size:12px; color:#6b7280; text-align:center; }
    .legend {
      position:absolute; z-index:1; bottom:16px; left:16px;
      background:#fff; padding:10px 12px; border-radius:8px; font:12px/1.4 system-ui;
      box-shadow:0 6px 20px rgba(0,0,0,.12);
    }
    .legend .bar { height:8px; width:180px; background:linear-gradient(90deg,#abd9e9,#ffffbf,#fee08b,#fdae61,#f46d43,#d73027); border-radius:4px; margin:6px 0 2px; }
  </style>
</head>
<body>
<div id="map"></div>

<!-- å³å´æ»‘å‡ºçµ±è¨ˆé¢æ¿ -->
<div id="sidePanel">
  <div class="sp-header">
    <div class="sp-header-top">
      <div class="sp-title" id="spTitle">é¸æ“‡ä¸€å€‹è¡Œæ”¿å€</div>
      <button class="sp-close" id="spClose" title="é—œé–‰">Ã—</button>
    </div>
    <select id="monthSelect">
      <option value="all">å…¨éƒ¨æœˆä»½</option>
      <option value="1">1 æœˆ</option><option value="2">2 æœˆ</option><option value="3">3 æœˆ</option>
      <option value="4">4 æœˆ</option><option value="5">5 æœˆ</option><option value="6">6 æœˆ</option>
      <option value="7">7 æœˆ</option><option value="8">8 æœˆ</option><option value="9">9 æœˆ</option>
      <option value="10">10 æœˆ</option><option value="11">11 æœˆ</option><option value="12">12 æœˆ</option>
    </select>
  </div>
  <div class="sp-body">
    <div class="sp-stat">
      <div class="sp-card"><div class="kpi" id="kpiTotal">0</div><div class="lbl">äº‹æ•…ç¸½æ•¸</div></div>
      <div class="sp-card"><div class="kpi" id="kpiA1">0</div><div class="lbl">A1 åš´é‡</div></div>
      <div class="sp-card"><div class="kpi" id="kpiA2">0</div><div class="lbl">A2 ä¸€èˆ¬</div></div>
    </div>

    <div class="chartTitle">å–®æœˆäº‹æ•…ç¨®é¡</div>
    <div class="chartBox"><canvas id="chartBar" width="280" height="180"></canvas></div>

    <div class="chartTitle" style="margin-top:10px;">å…¨å¹´äº‹æ•…è¶¨å‹¢ï¼ˆç¸½æ•¸ï¼‰</div>
    <div class="chartBox"><canvas id="chartLine" width="280" height="160"></canvas></div>

    <div class="chartTitle" style="margin-top:10px;">å–®æœˆç•¶äº‹è€…/è»Šç¨®åˆ†é¡</div>
    <div class="chartBox"><canvas id="chartPie" width="280" height="220"></canvas></div>
  </div>
</div>

<div class="legend">
  <b>äº‹æ•…ç†±åº¦</b>
  <div class="bar"></div>
  <div>ä½ â† ç†±åº¦ â†’ é«˜</div>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiYmlhYm9ibyIsImEiOiJjamVvejdlNXQxZnBuMndtdWhiZHRuaTNpIn0.PIS9wtUxm_rz_IzF2WFD1g';
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v11',
  center: [121.55, 25.06],
  zoom: 10.8
});

// ====== è»Šç¦è³‡æ–™ï¼ˆå¯å¤šæª”ï¼‰ ======
const sources = [
  './è‡ºåŒ—å¸‚åœ‹é“çµ±è¨ˆè»Šç¦æ•¸é‡.json',
  './è‡ºåŒ—å¸‚èˆªç©ºè­¦å¯Ÿçµ±è¨ˆè»Šç¦æ•¸é‡.json',
  './è‡ºåŒ—å¸‚å¸‚æ”¿åºœçµ±è¨ˆè»Šç¦å‚·äº¡.json'
];

function weightByType(type){
  if(type==='A1')return 1.0;
  if(type==='A2')return 0.6;
  return 0.4;
}

// å–ã€Œç•¶äº‹è€…å€åˆ†-é¡åˆ¥-å¤§é¡åˆ¥åç¨±-è»Šç¨®ã€æ¬„ä½ï¼ˆå¤šåå®¹éŒ¯ï¼‰
function partyCatFrom(row){
  return row['ç•¶äº‹è€…å€åˆ†-é¡åˆ¥-å¤§é¡åˆ¥åç¨±-è»Šç¨®']
      || row['ç•¶äº‹è€…å€åˆ†-é¡åˆ¥-å¤§é¡åˆ¥åç¨±']
      || row['ç•¶äº‹è€…è»Šç¨®']
      || row['è‚‡äº‹è»Šç¨®']
      || row['è»Šç¨®åç¨±']
      || row['è»Šç¨®']
      || '';
}

// å°‡ã€Œç™¼ç”Ÿæœˆä»½ã€å¯«å…¥ properties.monthï¼ˆæ•¸å­— 1~12ï¼‰ï¼Œä¸¦åŠ å…¥ partyCat
function toGeoJSON(arr){
  const feats=[];
  for(const row of arr){
    const lng=parseFloat(row['ç¶“åº¦']);
    const lat=parseFloat(row['ç·¯åº¦']);
    if(Number.isFinite(lng)&&Number.isFinite(lat)){
      feats.push({
        type:'Feature',
        geometry:{type:'Point',coordinates:[lng,lat]},
        properties:{
          year: row['ç™¼ç”Ÿå¹´åº¦'],
          month: Number(row['ç™¼ç”Ÿæœˆä»½']),
          date: row['ç™¼ç”Ÿæ—¥æœŸ'] || row['ç™¼ç”Ÿæ—¥'] || row['æ—¥æœŸ'] || '',
          time: row['ç™¼ç”Ÿæ™‚é–“'],
          kind: row['äº‹æ•…é¡åˆ¥åç¨±'],
          bureau: row['è™•ç†å–®ä½åç¨±è­¦å±€å±¤'],
          place: row['ç™¼ç”Ÿåœ°é»'],
          weather: row['å¤©å€™åç¨±'],
          light: row['å…‰ç·šåç¨±'],
          partyCat: partyCatFrom(row),   // ğŸ‘ˆ æ–°å¢ï¼šç•¶äº‹è€…/è»Šç¨®åˆ†é¡
          injured: row['æ­»äº¡å—å‚·äººæ•¸'],
          weight: weightByType(row['äº‹æ•…é¡åˆ¥åç¨±'])
        }
      });
    }
  }
  return {type:'FeatureCollection',features:feats};
}

async function loadAccidents(){
  const all=[];
  for(const url of sources){
    try{
      const res=await fetch(url);
      if(!res.ok)continue;
      const json=await res.json();
      all.push(...toGeoJSON(json).features);
    }catch(e){console.warn('è¼‰å…¥å¤±æ•—ï¼š',url,e);}
  }
  return {type:'FeatureCollection',features:all};
}

// ====== è¡Œæ”¿å€ï¼ˆG97_A_CADIST_P.jsonï¼Œ3826â†’WGS84ï¼‰ ======
proj4.defs('EPSG:3826','+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=GRS80 +units=m +no_defs');
function convertCoords(coords,type){
  if(type==='Point')return proj4('EPSG:3826','WGS84',coords);
  if(type==='Polygon'||type==='MultiLineString') return coords.map(r=>r.map(pt=>proj4('EPSG:3826','WGS84',pt)));
  if(type==='MultiPolygon') return coords.map(p=>p.map(r=>r.map(pt=>proj4('EPSG:3826','WGS84',pt))));
  return coords;
}
async function loadDistricts(){
  const r=await fetch('./G97_A_CADIST_P.json');
  const raw=await r.json();
  const fc=raw.type==='FeatureCollection'?raw:{type:'FeatureCollection',features:raw.features||[]};
  return {
    type:'FeatureCollection',
    features:fc.features.map(f=>({
      type:'Feature',
      properties:f.properties,
      geometry:{type:f.geometry.type,coordinates:convertCoords(f.geometry.coordinates,f.geometry.type)}
    }))
  };
}

// ====== å³å´é¢æ¿æ§åˆ¶ ======
const sidePanel=document.getElementById('sidePanel');
const spTitle=document.getElementById('spTitle');
const spClose=document.getElementById('spClose');
const kpiTotal=document.getElementById('kpiTotal');
const kpiA1=document.getElementById('kpiA1');
const kpiA2=document.getElementById('kpiA2');
const monthSelect=document.getElementById('monthSelect');
const chartBarCanvas=document.getElementById('chartBar');
const chartLineCanvas=document.getElementById('chartLine');
const chartPieCanvas=document.getElementById('chartPie');

let chartBar=null, chartLine=null, chartPie=null;
let currentDistrict=null;
let accidentsFC=null;

function openPanel(){sidePanel.classList.add('open');}
function closePanel(){sidePanel.classList.remove('open');}
spClose.addEventListener('click',closePanel);

// å–®æœˆæŸ±ç‹€åœ–
function renderBar(stats){
  if(chartBar) chartBar.destroy();
  chartBar=new Chart(chartBarCanvas.getContext('2d'),{
    type:'bar',
    data:{
      labels:['A1 åš´é‡','A2 ä¸€èˆ¬','å…¶ä»–'],
      datasets:[{label:'äº‹æ•…æ•¸é‡',data:[stats.A1,stats.A2,stats.other],backgroundColor:['#d73027','#fdae61','#2c7bb6']}]
    },
    options:{responsive:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}
  });
}

// å…¨å¹´æŠ˜ç·šåœ–ï¼ˆæ¯æœˆç¸½æ•¸ï¼‰
function renderLine(monthlyCounts){
  if(chartLine) chartLine.destroy();
  chartLine=new Chart(chartLineCanvas.getContext('2d'),{
    type:'line',
    data:{
      labels:['1','2','3','4','5','6','7','8','9','10','11','12'].map(m=>m+'æœˆ'),
      datasets:[{label:'æœˆäº‹æ•…ç¸½æ•¸',data:monthlyCounts,fill:false,tension:0.25,pointRadius:3}]
    },
    options:{responsive:false,plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}
  });
}

// å–®æœˆåˆ†é¡åœ“é¤…ï¼ˆç•¶äº‹è€…/è»Šç¨®ï¼‰
function renderPie(labelCounts){
  if(chartPie) chartPie.destroy();
  const labels = labelCounts.map(d=>d.label);
  const data = labelCounts.map(d=>d.count);
  const colors = [
    '#4c78a8','#f58518','#54a24b','#e45756','#72b7b2','#ff9da6',
    '#9c755f','#b279a2','#8cd17d','#eeca3b','#b1c5fd','#c4a7e7'
  ];
  chartPie=new Chart(chartPieCanvas.getContext('2d'),{
    type:'pie',
    data:{ labels, datasets:[{ data, backgroundColor: labels.map((_,i)=>colors[i%colors.length]) }] },
    options:{
      responsive:false,
      plugins:{
        legend:{ position:'bottom', labels:{ boxWidth:10, font:{ size:11 } } },
        tooltip:{ callbacks:{ label:(ctx)=>`${ctx.label}: ${ctx.raw} ä»¶ (${(ctx.raw / data.reduce((a,b)=>a+b,0) * 100).toFixed(1)}%)` } }
      }
    }
  });
}

// æ›´æ–°ç•¶å‰è¡Œæ”¿å€çµ±è¨ˆ
function updateDistrictStats(feature){
  if(!feature||!accidentsFC)return;
  const name=feature.properties?.TNAME||'ï¼ˆæœªå‘½åï¼‰';
  const selected=monthSelect.value;

  // è©²å€åŸŸå…§äº‹æ•…é»
  const ptsIn=turf.pointsWithinPolygon(accidentsFC,feature);

  // å…¨å¹´æ¯æœˆç¸½æ•¸
  const monthly=new Array(12).fill(0);
  for(const pt of ptsIn.features){
    const m=Number(pt.properties?.month);
    if(m>=1 && m<=12) monthly[m-1]+=1;
  }

  // ä¾é¸å®šæœˆä»½å–å­é›†åˆ
  const filtered=ptsIn.features.filter(pt=>{
    if(selected==='all') return true;
    return Number(pt.properties?.month) === Number(selected);
  });

  // å–®æœˆ A1/A2/å…¶ä»–
  const stats={A1:0,A2:0,other:0};
  for(const pt of filtered){
    const k=pt.properties?.kind;
    if(k==='A1')stats.A1++; else if(k==='A2')stats.A2++; else stats.other++;
  }

  // å–®æœˆ åˆ†é¡åœ“é¤…ï¼šä»¥ partyCat èšåˆï¼Œå– Top6 å…¶é¤˜æ­¸ã€Œå…¶ä»–ã€
  const mapCounts = new Map();
  for(const pt of filtered){
    const key = (pt.properties?.partyCat || 'æœªæ¨™ç¤º').toString().trim();
    mapCounts.set(key, (mapCounts.get(key)||0)+1);
  }
  const sorted = Array.from(mapCounts.entries())
    .map(([label,count])=>({label,count}))
    .sort((a,b)=>b.count-a.count);
  const topN = 6;
  const top = sorted.slice(0, topN);
  const rest = sorted.slice(topN).reduce((s,cur)=>s+cur.count,0);
  if(rest>0) top.push({label:'å…¶ä»–', count:rest});

  // æ›´æ–° UI èˆ‡åœ–è¡¨
  spTitle.textContent = `${name}ï¼ˆ${selected==='all'?'å…¨å¹´':selected+'æœˆ'}ï¼‰`;
  kpiTotal.textContent = filtered.length;
  kpiA1.textContent = stats.A1;
  kpiA2.textContent = stats.A2;

  renderBar(stats);
  renderLine(monthly);
  renderPie(top);
  openPanel();
}

monthSelect.addEventListener('change',()=>{ if(currentDistrict) updateDistrictStats(currentDistrict); });

map.on('load',async()=>{
  // äº‹æ•…
  accidentsFC=await loadAccidents();
  // === ä¾ ~100m ç¶²æ ¼è¨ˆç®—å¯†åº¦ï¼Œé¿å…ä¸€å¤§ç‰‡ç´… ===
  (function enrichDensity(fc) {
    const PREC = 3; // å°æ•¸ç¬¬3ä½ â‰ˆ 110mï¼›æƒ³æ›´ç²¾ç´°å¯æ”¹ 4ï¼ˆâ‰ˆ11mï¼‰
    const counts = new Map();

    // ç´¯è¨ˆæ¯å€‹ç¶²æ ¼çš„ã€ŒåŠ æ¬Šã€æ•¸é‡ï¼ˆæ²¿ç”¨ A1/A2 æ¬Šé‡ï¼‰
    for (const f of fc.features) {
      const [lng, lat] = f.geometry.coordinates;
      const key = `${lng.toFixed(PREC)},${lat.toFixed(PREC)}`;
      const w = Number(f.properties?.weight ?? 0.6);
      counts.set(key, (counts.get(key) || 0) + w);
    }

    // æ­£è¦åŒ–æˆ 0~1 çš„ densityï¼Œè®“ä¸åŒè³‡æ–™é‡ä¹Ÿæœ‰å°æ¯”
    let max = 0;
    for (const v of counts.values()) max = Math.max(max, v);

    for (const f of fc.features) {
      const [lng, lat] = f.geometry.coordinates;
      const key = `${lng.toFixed(PREC)},${lat.toFixed(PREC)}`;
      const sum = counts.get(key) || 0;
      const norm = max > 0 ? Math.sqrt(sum / max) : 0; // å¹³æ»‘ï¼šé«˜å¯†åº¦æ›´å‡¸é¡¯
      f.properties.gridCount = sum;   // è©²ç¶²æ ¼åŠ æ¬Šç­†æ•¸ï¼ˆå¯ç”¨æ–¼é™¤éŒ¯ï¼‰
      f.properties.density   = norm;  // 0~1
    }
  })(accidentsFC);
  map.addSource('accidents',{type:'geojson',data:accidentsFC});
  map.addLayer({
    id: 'accidents-heat',
    type: 'heatmap',
    source: 'accidents',
    maxzoom: 14,
    paint: {
      // ç”¨å¯†åº¦åšä¸»æ¬Šé‡ï¼Œäº‹æ•…ç­‰ç´šå†å¾®èª¿ï¼ˆA1 > A2 > å…¶ä»–ï¼‰
      'heatmap-weight': [
        '*',
        ['coalesce', ['get', 'density'], 0],           // 0~1ï¼ˆä¸Šé¢ç®—å¥½çš„ï¼‰
        ['interpolate', ['linear'], ['coalesce', ['get', 'weight'], 0.6],
          0.4, 0.9,   // å…¶ä»–
          0.6, 1.0,   // A2
          1.0, 1.2    // A1
        ]
      ],
      // åŠå¾‘/å¼·åº¦æ”¶æ–‚ï¼Œé¿å…å¤§ç‰‡èåˆ
      'heatmap-radius': [
        'interpolate', ['linear'], ['zoom'],
        8, 6,
        11, 10,
        14, 14
      ],
      'heatmap-intensity': [
        'interpolate', ['linear'], ['zoom'],
        8, 0.8,
        12, 0.8,
        14, 1.1
      ],
      // æé«˜è®Šç´…é–€æª»ï¼šåªæœ‰é«˜å¯†åº¦æ‰æœƒåˆ°ç´…
      'heatmap-color': [
        'interpolate', ['linear'], ['heatmap-density'],
        0.00, 'rgba(0,0,0,0)',
        0.10, '#abd9e9',
        0.25, '#ffffbf',
        0.45, '#fee08b',
        0.65, '#fdae61',
        0.82, '#f46d43',
        0.93, '#d73027'
      ],
      // æ”¾å¤§æ™‚è®“é»åœ–å±¤æ¥æ‰‹
      'heatmap-opacity': [
        'interpolate', ['linear'], ['zoom'],
        10, 0.85,
        13.5, 0.60,
        17, 0
      ]
    }
  });
  map.addLayer({
    id:'accidents-point',type:'circle',source:'accidents',minzoom:13,
    paint:{
      'circle-radius':['interpolate',['linear'],['zoom'],13,['*',1.8,['get','weight']],16,['*',6,['get','weight']]],
      'circle-color':['case',['==',['get','kind'],'A1'],'#d73027',['==',['get','kind'],'A2'],'#fdae61','#2c7bb6'],
      'circle-stroke-color':'#fff','circle-stroke-width':1,'circle-opacity':0.9
    }
  });

  // è¡Œæ”¿å€
  const districts=await loadDistricts();
  map.addSource('taipei-districts',{type:'geojson',data:districts});
  map.addLayer({id:'district-fill',type:'fill',source:'taipei-districts',paint:{'fill-color':'#9ab0ff','fill-opacity':0.06}},'accidents-point');
  map.addLayer({id:'district-borders',type:'line',source:'taipei-districts',
    paint:{'line-color':'#2b3a67','line-width':['interpolate',['linear'],['zoom'],10,1,12,1.8,14,2.5],'line-opacity':0.95}},'accidents-point');
  map.addLayer({id:'district-labels',type:'symbol',source:'taipei-districts',
    layout:{'text-field':['coalesce',['get','TNAME'],'ï¼ˆæœªå‘½åï¼‰'],'text-size':['interpolate',['linear'],['zoom'],10,10,14,14],'text-anchor':'center','text-allow-overlap':false},
    paint:{'text-color':'#24324b','text-halo-color':'rgba(255,255,255,0.9)','text-halo-width':1.2}},'accidents-point');

  // é»æ“Šè¡Œæ”¿å€ â†’ å³å´é¢æ¿
  map.on('click','district-fill',e=>{
    const f=e.features&&e.features[0];
    if(!f)return;
    currentDistrict=f;
    updateDistrictStats(f);
  });
});
</script>
</body>
</html>
