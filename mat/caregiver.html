<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è³‡æ–™å„€è¡¨æ¿</title>
  <link rel="stylesheet" href="elder-dashboard.css" />
  <style>
    /* è³‡æ–™å„€è¡¨æ¿å°ˆç”¨æ¨£å¼ */
    body {
      overflow: auto;
    }

    #app {
      max-width: 100%;
      padding-bottom: 0;
    }

    .data-dashboard-header {
      background: linear-gradient(135deg, #161b47 0%, #374087 100%);
      color: white;
      padding: 20px 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .dashboard-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .dashboard-subtitle {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 16px;
    }

    .dashboard-toolbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .toolbar-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .toolbar-btn.primary {
      background: #3498db;
      color: white;
    }

    .toolbar-btn.secondary {
      background: #9b59b6;
      color: white;
    }

    .toolbar-btn.danger {
      background: #e74c3c;
      color: white;
    }

    .toolbar-btn.neutral {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      text-decoration: none;
      display: inline-block;
    }

    .toolbar-btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .connection-status {
      margin-left: auto;
      font-size: 12px;
      opacity: 0.8;
    }

    .dashboard-content {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #2d3748;
      margin: 24px 0 16px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
    }

    /* äº‹ä»¶åˆ—è¡¨æ¨£å¼ */
    .events-table-wrapper {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      overflow-x: auto;
    }

    .events-table {
      width: 100%;
      border-collapse: collapse;
    }

    .events-table th,
    .events-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
      font-size: 13px;
    }

    .events-table th {
      background: #f8fafc;
      font-weight: 700;
      color: #475569;
    }

    .events-table tbody tr:hover {
      background: #f8fafc;
    }

    .event-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
    }

    .event-badge.leave {
      background: #fee2e2;
      color: #991b1b;
    }

    .event-badge.return {
      background: #dcfce7;
      color: #166534;
    }

    /* çµ±è¨ˆæ¦‚è¦½ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #3498db;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 13px;
      color: #64748b;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Header -->
    <header class="data-dashboard-header">
      <h1 class="dashboard-title">è³‡æ–™å„€è¡¨æ¿</h1>
      <p class="dashboard-subtitle">å³æ™‚ç›£æ§æ‰€æœ‰åºŠä½ç‹€æ…‹èˆ‡ç¡çœ æ•¸æ“š</p>
      
      <div class="dashboard-toolbar">
        <button id="enable-notify" class="toolbar-btn primary">ğŸ”” å•Ÿç”¨é€šçŸ¥</button>
        <button id="test-connection" class="toolbar-btn secondary">ğŸ”Œ æ¸¬è©¦é€£ç·š</button>
        <button id="clear-view" class="toolbar-btn danger">ğŸ—‘ï¸ æ¸…ç©ºç•«é¢</button>
        <a href="index.html" class="toolbar-btn neutral">â† å›æ¨¡æ“¬å™¨</a>
        <span id="connection-status" class="connection-status">é€£ç·šç‹€æ…‹ï¼šæœªæ¸¬è©¦</span>
      </div>
    </header>

    <!-- Main Content -->
    <div class="dashboard-content">
      <!-- Statistics Overview -->
      <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="total-beds">16</div>
          <div class="stat-label">ç¸½åºŠä½æ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="in-bed-count">0</div>
          <div class="stat-label">åœ¨åºŠä¸­</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="out-bed-count">0</div>
          <div class="stat-label">é›¢åºŠä¸­</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-interruptions">0</div>
          <div class="stat-label">ä»Šæ—¥ä¸­æ–·ç¸½æ¬¡æ•¸</div>
        </div>
      </div>

      <!-- Elder Beds Grid -->
      <h2 class="section-title">ğŸ“Š æ‰€æœ‰åºŠä½å³æ™‚ç‹€æ…‹</h2>
      <div class="elder-grid" id="elder-grid">
        <!-- Cards will be dynamically generated -->
      </div>

      <!-- Recent Events -->
      <h2 class="section-title">ğŸ“ æœ€æ–°äº‹ä»¶è¨˜éŒ„</h2>
      <div class="events-table-wrapper">
        <table class="events-table">
          <thead>
            <tr>
              <th>æ™‚é–“</th>
              <th>åºŠä½ç·¨è™Ÿ</th>
              <th>äº‹ä»¶é¡å‹</th>
              <th>ç¾¤çµ„å…§åœ°å¢Š</th>
            </tr>
          </thead>
          <tbody id="event-rows">
            <tr>
              <td colspan="4" style="text-align: center; color: #94a3b8; padding: 24px;">
                å°šç„¡äº‹ä»¶è¨˜éŒ„
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

  <!-- Firebase Config -->
  <script src="firebase-config.js"></script>

  <!-- Data Dashboard Script -->
  <script src="data-dashboard.js"></script>
</body>
</html>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

  <!-- Firebase é…ç½®ï¼ˆè«‹å…ˆä¾ FIREBASE_SETUP.md è¨­å®šï¼‰ -->
  <script src="firebase-config.js"></script>

  <script>
    // ç…§è­·è€…ç«¯ï¼šå³æ™‚ç›£è½ sleep_eventsï¼Œä¸¦åœ¨é›¢åºŠæ™‚ç™¼å‡ºç€è¦½å™¨é€šçŸ¥
    const state = {
      elders: {}, // elderId -> { status, interruptions, lastTs }
      notifyEnabled: false
    };

    function formatTime(ts) {
      try { return new Date(ts).toLocaleString('zh-TW'); } catch(e) { return ''+ts; }
    }

    function ensureElder(elderId) {
      if (!state.elders[elderId]) {
        state.elders[elderId] = { status: 'UNKNOWN', interruptions: 0, lastTs: null };
      }
      return state.elders[elderId];
    }

    function renderCards() {
      const wrap = document.getElementById('elder-cards');
      const ids = Object.keys(state.elders).sort((a,b)=>a.localeCompare(b, 'zh-TW', {numeric:true}));
      wrap.innerHTML = ids.map(id => {
        const e = state.elders[id];
        const statusClass = e.status === 'IN_BED' ? 'inbed' : (e.status === 'OUT_OF_BED' ? 'outbed' : '');
        const statusText = e.status === 'IN_BED' ? 'åœ¨åºŠä¸Š' : (e.status === 'OUT_OF_BED' ? 'é›¢åºŠä¸­' : 'æœªçŸ¥');
        return `
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
              <div>
                <div style="font-size:16px;font-weight:800;">${id}</div>
                <div class="muted">æœ€å¾Œæ›´æ–°ï¼š${e.lastTs ? formatTime(e.lastTs) : 'â€”'}</div>
              </div>
              <div class="status ${statusClass}">${statusText}</div>
            </div>
            <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
              <div><span class="muted">å¤œé–“ä¸­æ–·ï¼š</span><b>${e.interruptions}</b> æ¬¡</div>
            </div>
          </div>
        `;
      }).join('');
    }

    
function updateElderSelect() {
  const sel = document.getElementById('elder-select');
  if (!sel) return;
  const elders = Object.keys(state.elders).sort();
  const current = sel.value;
  sel.innerHTML = '';
  if (elders.length === 0) {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'ï¼ˆå°šç„¡è³‡æ–™ï¼‰';
    sel.appendChild(opt);
    return;
  }
  elders.forEach(id => {
    const opt = document.createElement('option');
    opt.value = id;
    opt.textContent = id;
    sel.appendChild(opt);
  });
  if (current && elders.includes(current)) sel.value = current;
}

async function loadWeeklyReport(elderId) {
  const rowsEl = document.getElementById('weekly-rows');
  const summaryEl = document.getElementById('weekly-summary');
  if (!rowsEl || !summaryEl) return;
  rowsEl.innerHTML = '';
  summaryEl.textContent = 'è¼‰å…¥ä¸­â€¦';

  if (typeof firebaseManager === 'undefined' || !firebaseManager.getSleepSessions) {
    summaryEl.textContent = 'Firebase è®€å–å‡½æ•¸æœªå°±ç·’ï¼ˆè«‹ç¢ºèª firebase-config.js å·²æ›´æ–°ï¼‰ã€‚';
    return;
  }

  const sessions = await firebaseManager.getSleepSessions(elderId, 50);
  // åªå–æœ€è¿‘ 7 å¤©ï¼ˆä¾ sessionKeyï¼‰
  const now = new Date();
  const cutoff = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  const keep = sessions.filter(s => {
    if (!s.sessionKey) return false;
    const d = new Date(s.sessionKey + 'T00:00:00');
    return d >= cutoff;
  }).sort((a,b)=> (a.sessionKey||'').localeCompare(b.sessionKey||''));

  if (keep.length === 0) {
    summaryEl.textContent = 'æœ€è¿‘ 7 å¤©å°šç„¡ sleep_sessions è³‡æ–™ï¼ˆå¯åœ¨æ¨¡æ“¬å™¨æŒ‰ã€ŒçµæŸç¡çœ ã€ç”¢ç”Ÿï¼‰ã€‚';
    return;
  }

  let totalSleep = 0;
  let totalInt = 0;
  keep.forEach(s => {
    totalSleep += Number(s.totalSleepMinutes || 0);
    totalInt += Number(s.interruptions || 0);
    const abnormal = s.abnormalFlags ? Object.keys(s.abnormalFlags).join(',') : '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${s.sessionKey || ''}</td>
      <td>${s.totalSleepMinutes ?? ''}</td>
      <td>${s.interruptions ?? ''}</td>
      <td>${s.outOfBedMinutes ?? ''}</td>
      <td>${s.cyclesEstimate ?? ''}</td>
      <td>${abnormal}</td>
    `;
    rowsEl.appendChild(tr);
  });

  const avgSleep = Math.round(totalSleep / keep.length);
  summaryEl.textContent = `å…± ${keep.length} å¤© | å¹³å‡ç¡çœ  ${avgSleep} åˆ†é˜ | ä¸­æ–·ç¸½æ¬¡æ•¸ ${totalInt} æ¬¡`;
}

function prependRow(ev) {
      const tbody = document.getElementById('event-rows');
      const tr = document.createElement('tr');
      const pill = ev.eventType === 'LEAVE_BED'
        ? '<span class="pill leave">é›¢åºŠ</span>'
        : '<span class="pill return">å›åºŠ</span>';
      tr.innerHTML = `
        <td>${formatTime(ev.ts)}</td>
        <td>${ev.elderId}</td>
        <td>${pill}</td>
        <td>${ev.groupId} / #${ev.matNumber}</td>
      `;
      tbody.prepend(tr);
      // åªä¿ç•™æœ€è¿‘ 100 ç­†
      while (tbody.children.length > 100) tbody.removeChild(tbody.lastChild);
    }

    async function enableNotification() {
      if (!('Notification' in window)) {
        alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Notification API');
        return;
      }
      const permission = await Notification.requestPermission();
      state.notifyEnabled = permission === 'granted';
      alert(state.notifyEnabled ? 'é€šçŸ¥å·²å•Ÿç”¨' : 'é€šçŸ¥æœªå•Ÿç”¨ï¼ˆè¢«æ‹’çµ•æˆ–æœªæˆæ¬Šï¼‰');
    }

    function notifyLeaveBed(ev) {
      if (!state.notifyEnabled) return;
      try {
        new Notification('âš ï¸ é›¢åºŠæé†’', {
          body: `${ev.elderId} å·²é›¢åºŠï¼ˆ${formatTime(ev.ts)}ï¼‰`,
        });
      } catch (e) {}
    }

    async function main() {
      if (typeof firebaseManager === 'undefined') {
        alert('æ‰¾ä¸åˆ° firebaseManagerï¼Œè«‹ç¢ºèª firebase-config.js æ˜¯å¦æ­£ç¢º');
        return;
      }
      await firebaseManager.init();

      // æ¸¬è©¦ Firebase é€£ç·šçš„å‡½æ•¸
      async function testFirebaseConnection() {
        const statusEl = document.getElementById('connection-status');
        const testBtn = document.getElementById('test-connection');
        
        if (!statusEl) return;
        
        // é¡¯ç¤ºæ¸¬è©¦ä¸­
        statusEl.innerHTML = 'ğŸ”„ é€£ç·šæ¸¬è©¦ä¸­...';
        statusEl.style.color = '#f39c12';
        if (testBtn) testBtn.disabled = true;

        try {
          const result = await firebaseManager.testConnection();
          
          if (result.success) {
            statusEl.innerHTML = `âœ… é€£ç·šæ­£å¸¸ (å»¶é²: ${result.details.latency}ms)`;
            statusEl.style.color = '#16a34a';
            statusEl.style.fontWeight = '600';
            
            // åœ¨æ§åˆ¶å°é¡¯ç¤ºè©³ç´°è³‡è¨Š
            console.log('Firebase é€£ç·šæ¸¬è©¦æˆåŠŸ:', result);
          } else {
            statusEl.innerHTML = `âŒ é€£ç·šå¤±æ•—: ${result.error || 'æœªçŸ¥éŒ¯èª¤'}`;
            statusEl.style.color = '#dc2626';
            statusEl.style.fontWeight = '600';
            
            console.error('Firebase é€£ç·šæ¸¬è©¦å¤±æ•—:', result);
            alert(`Firebase é€£ç·šå¤±æ•—\n\néŒ¯èª¤è¨Šæ¯: ${result.message}\nè©³æƒ…: ${result.error}`);
          }
        } catch (error) {
          statusEl.innerHTML = `âŒ æ¸¬è©¦ç•°å¸¸`;
          statusEl.style.color = '#dc2626';
          console.error('æ¸¬è©¦ç•°å¸¸:', error);
        } finally {
          if (testBtn) testBtn.disabled = false;
        }
      }

      // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦é€£ç·š
      await testFirebaseConnection();

// ï¼ˆå¯é¸ï¼‰FCM Web Pushï¼šè‹¥å·²è¨­å®š window.FCM_VAPID_KEYï¼Œå°‡ä½¿ç”¨ FCM å–å¾— token ä¸¦æ¥æ”¶æ¨æ’­
async function initFCM() {
  try {
    if (!window.FCM_VAPID_KEY) return;
    if (!('serviceWorker' in navigator)) return;

    // register SW
    const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');

    const messaging = firebase.messaging();
    await Notification.requestPermission();

    const token = await messaging.getToken({
      vapidKey: window.FCM_VAPID_KEY,
      serviceWorkerRegistration: reg
    });

    console.log('FCM token:', token);

    // å¯é¸ï¼šæŠŠ token å¯«å›è³‡æ–™åº«ï¼Œä¾› Cloud Function æ¨æ’­ï¼ˆéœ€è¦ä½ è‡ªå·±å»ºç«‹ caregivers/tokensï¼‰
    // await firebase.database().ref('caregiver_tokens').push({ token, createdAt: new Date().toISOString() });

    messaging.onMessage((payload) => {
      const title = payload.notification?.title || 'SmartMat é€šçŸ¥';
      const body = payload.notification?.body || '';
      if (Notification.permission === 'granted') {
        new Notification(title, { body });
      }
    });
  } catch (e) {
    console.warn('FCM init skipped/failed:', e);
  }
}
initFCM();


      const ref = firebase.database().ref('sleep_events').orderByChild('ts').limitToLast(100);
      ref.on('child_added', (snap) => {
        const ev = snap.val();
        if (!ev || !ev.elderId) return;
        const elder = ensureElder(ev.elderId);

        if (ev.eventType === 'LEAVE_BED') {
          elder.status = 'OUT_OF_BED';
          elder.interruptions += 1;
          notifyLeaveBed(ev);
        } else if (ev.eventType === 'ABNORMAL_SLEEP') {
          // ç•°å¸¸æé†’äº‹ä»¶ï¼ˆç”±æ¨¡æ“¬å™¨ endSleepSession è§¸ç™¼ï¼‰
          elder.status = elder.status || 'UNKNOWN';
          notifyLeaveBed({ ...ev, title: 'ç•°å¸¸ç¡çœ æé†’', body: 'åµæ¸¬åˆ°ç•°å¸¸ç¡çœ æŒ‡æ¨™ï¼Œå»ºè­°æŸ¥çœ‹é€±å ±/é—œæ‡·é•·è€…' });
        } else if (ev.eventType === 'RETURN_BED') {
          elder.status = 'IN_BED';
        }
        elder.lastTs = ev.ts;

        renderCards();
        updateElderSelect();
        prependRow(ev);
      });
    }

    document.getElementById('test-connection').addEventListener('click', async () => {
      const statusEl = document.getElementById('connection-status');
      const testBtn = document.getElementById('test-connection');
      
      statusEl.innerHTML = 'ğŸ”„ é€£ç·šæ¸¬è©¦ä¸­...';
      statusEl.style.color = '#f39c12';
      testBtn.disabled = true;

      try {
        const result = await firebaseManager.testConnection();
        
        if (result.success) {
          statusEl.innerHTML = `âœ… é€£ç·šæ­£å¸¸ (å»¶é²: ${result.details.latency}ms)`;
          statusEl.style.color = '#16a34a';
          statusEl.style.fontWeight = '600';
          console.log('Firebase é€£ç·šæ¸¬è©¦æˆåŠŸ:', result);
        } else {
          statusEl.innerHTML = `âŒ é€£ç·šå¤±æ•—: ${result.error || 'æœªçŸ¥éŒ¯èª¤'}`;
          statusEl.style.color = '#dc2626';
          statusEl.style.fontWeight = '600';
          console.error('Firebase é€£ç·šæ¸¬è©¦å¤±æ•—:', result);
          alert(`Firebase é€£ç·šå¤±æ•—\n\néŒ¯èª¤è¨Šæ¯: ${result.message}\nè©³æƒ…: ${result.error}`);
        }
      } catch (error) {
        statusEl.innerHTML = `âŒ æ¸¬è©¦ç•°å¸¸`;
        statusEl.style.color = '#dc2626';
        console.error('æ¸¬è©¦ç•°å¸¸:', error);
      } finally {
        testBtn.disabled = false;
      }
    });

    document.getElementById('enable-notify').addEventListener('click', enableNotification);
    document.getElementById('refresh-weekly').addEventListener('click', () => {
      const sel = document.getElementById('elder-select');
      if (sel && sel.value) loadWeeklyReport(sel.value);
    });
    document.getElementById('elder-select').addEventListener('change', (e) => {
      if (e.target.value) loadWeeklyReport(e.target.value);
    });
    document.getElementById('clear-view').addEventListener('click', () => {
      document.getElementById('event-rows').innerHTML = '';
      state.elders = {};
      renderCards();
    });

    main();
  </script>
</body>
</html>
